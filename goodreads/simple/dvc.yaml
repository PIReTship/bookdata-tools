stages:
  scan-interactions:
    cmd: python ../../run.py --rust goodreads scan interactions --csv --book-map ../../data/goodreads/book_id_map.csv ../../data/goodreads/goodreads_interactions.csv
    deps:
    - ../../src/cli/goodreads
    - ../../src/goodreads
    - ../../data/goodreads/book_id_map.csv
    - ../../data/goodreads/goodreads_interactions.csv
    outs:
    - gr-interactions.parquet

  cluster-actions:
    cmd: python run.py --rust goodreads cluster-interactions --add-actions --simple -o goodreads/simple/gr-cluster-actions.parquet
    wdir: ../..
    deps:
    - src/goodreads/cluster.rs
    - goodreads/simple/gr-interactions.parquet
    - goodreads/gr-book-link.parquet
    outs:
    - goodreads/simple/gr-cluster-actions.parquet

  cluster-ratings:
    cmd: python run.py --rust goodreads cluster-interactions --ratings --simple -o goodreads/simple/gr-cluster-ratings.parquet
    wdir: ../..
    deps:
    - src/goodreads/cluster.rs
    - goodreads/simple/gr-interactions.parquet
    - goodreads/gr-book-link.parquet
    outs:
    - goodreads/simple/gr-cluster-ratings.parquet

  work-actions:
    cmd: python run.py --rust goodreads cluster-interactions --add-actions --simple -o goodreads/simple/gr-work-actions.parquet
    wdir: ../..
    deps:
    - src/goodreads/cluster.rs
    - goodreads/simple/gr-interactions.parquet
    - goodreads/gr-book-link.parquet
    outs:
    - goodreads/simple/gr-work-actions.parquet

  work-ratings:
    cmd: python run.py --rust goodreads cluster-interactions --ratings --simple -o goodreads/simple/gr-work-ratings.parquet
    wdir: ../..
    deps:
    - src/goodreads/cluster.rs
    - goodreads/simple/gr-interactions.parquet
    - goodreads/gr-book-link.parquet
    outs:
    - goodreads/simple/gr-work-ratings.parquet

  schema:
    foreach:
    - gr-interactions
    - gr-cluster-actions
    - gr-cluster-ratings
    - gr-work-actions
    - gr-work-ratings
    do:
      cmd: python ../../run.py --rust pq-info -o ${item}.json ${item}.parquet
      deps:
      - ${item}.parquet
      outs:
      - ${item}.json:
          cache: false
